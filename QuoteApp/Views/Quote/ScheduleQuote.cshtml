@using QuoteApp.Models
@model QuoteApp.Models.ScheduleWorkViewModel
@{
    ViewBag.Title = "ScheduleQuote";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<h3>Schedule work for @Model.QuoteId</h3>

<div class="form-horizontal">
    <div class="form-group">
        <label for="WorkStarts" class="col-sm-2 control-label">Start work at</label>
        <div class="col-sm-3">
            @Html.TextBoxFor(m => m.WorkStarts, new { @class = "form-control" })
        </div>
    </div>
    <div class="form-group">
        <label for="NumberOfDays" class="col-sm-2 control-label">It will take these many days</label>
        <div class="col-sm-1">
            @Html.TextBoxFor(m => m.NumberOfDays, new { @class = "form-control" })
        </div>
    </div>

</div>
<table class="table table-striped" id="worksTable">
    <thead>
        <tr>
            <th style="width: 10%">Court</th>
            <th style="width: 15%">Work type</th>
            <th style="width: 55%">Description</th>
            <th style="width: 10%">Price</th>
            <th style="width: 10%">Accepted #</th>
        </tr>
    </thead>
    <tbody>
        @foreach (QuotedWork quotedWork in Model.QuotedWorks)
        {
            <tr>
                <td contenteditable="true">@quotedWork.QuotedWorkMainAreaName</td>
                <td contenteditable="true">@quotedWork.WorkTitle</td>
                <td contenteditable="true">@quotedWork.QuotedWorkDescription</td>
                <td contenteditable="true">£@quotedWork.QuotedWorkPrice</td>
                <td contenteditable="true">@quotedWork.NumberOfCourts</td>
                <td style="display: none">@quotedWork.QuotedWorkId</td>
            </tr>
        }
    </tbody>
    <tfoot>
        <tr>
            <td><button class="btn btn-success"><i class="glyphicon glyphicon-plus"></i></button></td>
            <td colspan="2" style="text-align: right;">Total expected income:</td>
            <td colspan="2"><strong>£@Model.TotalPrice</strong></td>
        </tr>
    </tfoot>
</table>

<button class="btn btn-success" onclick="scheduleWork();">Schedule work</button>
@Html.HiddenFor(m => m.QuoteId)
@Html.ActionLink("Maybe not", "Index", "Home", null, new { @class = "btn btn-default" })

<div id="jobSelector" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="myModalLabel">Select the work to insert</h4>
            </div>
            <div class="modal-body">
                <div role="tabpanel">

                    <!-- Nav tabs -->
                    <ul class="nav nav-tabs" role="tablist" id="workTypeTabs">
                        @foreach (string workType in Model.WorkTypes)
                        {
                            <li role="presentation"><a href="#@workType.ToLower()" role="tab" data-toggle="tab">@workType</a></li>
                        }
                    </ul>

                    <!-- Tab panes -->
                    <div class="tab-content">

                        @foreach (string workType in Model.WorkTypes)
                        {
                            <div role="tabpanel" class="tab-pane" id="@workType.ToLower()">
                                <div class="panel-group" id="@string.Format("accordion{0}",workType)" role="tablist" aria-multiselectable="true">
                                    @foreach (WorkViewModel work in Model.Works.Where(m => m.WorkAreaName.Equals(workType)))
                                    {
                                        <div class="panel panel-default">
                                            <div class="panel-heading" role="tab" id="@string.Format("{0}Heading",@work.WorkName.Replace(" ", ""))">
                                                <h4 class="panel-title">
                                                    <a data-toggle="collapse" data-parent="#accordion" href="#@work.WorkName.Replace(" ", "")" aria-expanded="false" aria-controls="@work.WorkName.Replace(" ", "")">
                                                        @work.WorkName
                                                    </a>
                                                </h4>
                                                <button class="btn btn-xs btn-info" onclick="selectWork('@string.Format("{0}Text",@work.WorkName.Replace(" ", ""))', '@work.WorkPrice','@work.WorkName');" data-dismiss="modal">Select</button>
                                            </div>
                                            <div id="@work.WorkName.Replace(" ", "")" class="panel-collapse collapse" role="tabpanel" aria-labelledby="@string.Format("{0}Heading",@work.WorkName.Replace(" ", ""))">
                                                <input type="hidden" id="@string.Format("{0}Price",@work.WorkName.Replace(" ", ""))" value="@work.WorkPrice" />
                                                <div class="panel-body" id="@string.Format("{0}Text",@work.WorkName.Replace(" ", ""))">
                                                    @work.WorkDescription
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>

                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>

    <input type="hidden" id="selectedRowId" />


</div>

@section Scripts{
    <script type="text/javascript" src="~/Scripts/jquery-ui-1.11.2.min.js"></script>
    <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.1/themes/base/jquery-ui.css" />
    <script type="text/javascript">
        $("#WorkStarts").datepicker({ dateFormat: 'dd/mm/yy' });
        
        function addWork() {
            
        }
        
        function scheduleWork() {

            var quotedWorks = [];

            $('#worksTable > tbody >tr').each(function () {
                var cells = $(this).find('td');
                quotedWorks.push({
                    'QuotedWorkId': cells[5].innerText,
                    'QuotedWorkMainAreaName': cells[0].innerText,
                    'WorkTitle': cells[1].innerText,
                    'QuotedWorkDescription': cells[2].innerText,
                    'Accepted': cells[4].innerText,
                    'QuotedWorkPrice': cells[3].innerText.replace("£", "")
                });
            });

            var scheduleWorkViewModel = {
                'NumberOfDays': $('#NumberOfDays').val(),
                'WorkStarts': $("#WorkStarts").val(),
                'QuoteId': $("#QuoteId").val(),
                'QuotedWorks': quotedWorks
            };

            $.ajax({
                type: "POST",
                url: '@Url.Action("ScheduleQuoteJson")',
                dataType: "json",
                data: { scheduleWorkViewModel: JSON.stringify(scheduleWorkViewModel) },
                success: function (data) {
                    location.href = '@Url.Action("Index", "Home")';
                },
                error: function(data) {
                     alert("Something bad happened: " + data);
                }
            });
        }

        

    </script>
}
